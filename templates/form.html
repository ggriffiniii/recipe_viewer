{% extends "layout.html" %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow">
    <h1 class="text-2xl font-bold mb-6 text-gray-900">{% if is_edit %}Edit Recipe{% else %}New Recipe{% endif %}</h1>

    {% if !is_edit %}
    <div class="mb-8 p-4 bg-indigo-50 border border-indigo-100 rounded-md">
        <h2 class="text-sm font-semibold text-indigo-900 mb-1">Recipe Importer Bookmarklet</h2>
        <p class="text-xs text-indigo-700 mb-3">Drag this link to your bookmarks bar to import recipes from any website
            with one click:</p>
        <a id="bookmarklet-link" href="#"
            class="inline-flex items-center px-3 py-1.5 border border-indigo-300 shadow-sm text-xs font-medium rounded-md text-indigo-700 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 cursor-move">
            <svg class="h-4 w-4 mr-1.5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
            </svg>
            Import to Recipe Viewer
        </a>
    </div>
    {% endif %}

    <form id="recipe-form"
        action="{% if is_edit %}/recipes/{{ recipe.as_ref().unwrap().id }}{% else %}/recipes{% endif %}" method="post"
        class="space-y-6">
        <div>
            <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
            <input type="text" name="title" id="title" required
                value="{% if is_edit %}{{ recipe.as_ref().unwrap().title }}{% endif %}"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
        </div>

        <div>
            <label for="url" class="block text-sm font-medium text-gray-700">Recipe URL</label>
            <div class="mt-1 flex rounded-md shadow-sm">
                <input type="url" name="url" id="url"
                    value="{% if let Some(u) = initial_url %}{{ u }}{% else if let Some(r) = recipe %}{% if let Some(url) = r.url %}{{ url }}{% endif %}{% endif %}"
                    class="flex-1 min-w-0 block w-full rounded-none rounded-l-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"
                    placeholder="https://example.com/recipe">
                <button type="button" id="auto-fill-btn"
                    class="relative -ml-px inline-flex items-center space-x-2 rounded-r-md border border-gray-300 bg-gray-50 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"
                            clip-rule="evenodd" />
                    </svg>
                    <span>Auto-fill</span>
                </button>
            </div>
            <p id="import-status" class="mt-2 text-sm text-gray-500 hidden"></p>
        </div>

        <div>
            <label for="overview" class="block text-sm font-medium text-gray-700">Overview (Optional)</label>
            <textarea name="overview" id="overview" rows="3"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">{% if is_edit %}{% if let Some(overview) = recipe.as_ref().unwrap().overview %}{{ overview }}{% endif %}{% endif %}</textarea>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700">Ingredients</label>
            <p class="text-xs text-gray-500 mb-2">Add ingredients with quantity, unit, and name.</p>

            <div id="ingredients-container" class="space-y-2 mb-2">
                <!-- Ingredient rows will be inserted here -->
            </div>

            <button type="button" id="add-ingredient-btn"
                class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="h-4 w-4 mr-1 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Ingredient
            </button>

            <!-- Hidden input to store the actual value sent to server (legacy) / used for initialization -->
            <input type="hidden" name="ingredients_text" id="ingredients_text"
                value="{% if is_edit %}{% for ingredient in ingredients %}{% if let Some(q) = ingredient.quantity %}{{ q }} {% endif %}{% if let Some(unit) = ingredient.unit %}{{ unit }} {% endif %}{{ ingredient.name }}&#10;{% endfor %}{% endif %}">

            <datalist id="unit-options">
                <option value="cup">
                <option value="cups">
                <option value="tbsp">
                <option value="tsp">
                <option value="oz">
                <option value="lb">
                <option value="g">
                <option value="kg">
                <option value="ml">
                <option value="l">
                <option value="pinch">
                <option value="dash">
                <option value="clove">
                <option value="can">
                <option value="slice">
            </datalist>
        </div>

        <div>
            <label for="instructions" class="block text-sm font-medium text-gray-700">Instructions (Optional)</label>
            <textarea name="instructions" id="instructions" rows="10"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">{% if is_edit %}{% if let Some(instr) = recipe.as_ref().unwrap().instructions %}{{ instr }}{% endif %}{% endif %}</textarea>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700">Tags</label>
            <p class="text-xs text-gray-500 mb-2">Type and press Enter or Comma to add tags</p>

            <div class="relative">
                <div id="tags-container"
                    class="mt-1 flex flex-wrap gap-2 p-2 border border-gray-300 rounded-md bg-white min-h-[42px] focus-within:ring-1 focus-within:ring-indigo-500 focus-within:border-indigo-500 shadow-sm">
                    <!-- Badges will be inserted here -->
                    <input type="text" id="tag-input"
                        class="flex-grow min-w-[120px] outline-none border-none focus:ring-0 p-0 text-sm"
                        placeholder="Add a tag..." autocomplete="off">
                </div>
                <!-- Dropdown -->
                <div id="tag-dropdown"
                    class="absolute z-10 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm hidden">
                    <!-- Options will be inserted here -->
                </div>
            </div>

            <!-- Hidden input to store initialization value. New submission uses JSON, so this is just for init. -->
            <input type="hidden" name="tags_text" id="tags_text"
                value="{% if is_edit %}{% for tag in tags %}{{ tag.name }}{% if !loop.last %}, {% endif %}{% endfor %}{% endif %}">
        </div>

        <script>
            // Available tags from server, ordered by popularity
            const AVAILABLE_TAGS = {{ all_tags_json| safe }};

            const SERVER_INGREDIENTS = {{ ingredients_json| safe }};

            document.addEventListener('DOMContentLoaded', () => {
                // Initialize bookmarklet
                const bookmarkletLink = document.getElementById('bookmarklet-link');
                if (bookmarkletLink) {
                    const origin = window.location.origin;
                    const bookmarklet = `javascript:(function(){window.location.href='${origin}/recipes/new?url='+encodeURIComponent(window.location.href);})();`;
                    bookmarkletLink.href = bookmarklet;
                }

                const container = document.getElementById('tags-container');
                const input = document.getElementById('tag-input');
                const hiddenInput = document.getElementById('tags_text');
                const dropdown = document.getElementById('tag-dropdown');

                // Initialize tags from the server-rendered value
                let tags = hiddenInput.value.split(',')
                    .map(t => t.trim())
                    .filter(t => t.length > 0);

                let selectedIndex = -1;

                // Make removeTag distinct for global access if needed, or stick to closure with button binding
                // Binding in creates span is cleaner.

                function renderTags() {
                    // Remove existing badges (spans)
                    const existingSpans = container.querySelectorAll('span.inline-flex');
                    existingSpans.forEach(span => span.remove());

                    // Create document fragment for new badges
                    const fragment = document.createDocumentFragment();

                    tags.forEach((tag, index) => {
                        const span = document.createElement('span');
                        span.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800';
                        span.innerHTML = `
                            ${tag}
                            <button type="button" class="ml-1 inline-flex items-center p-0.5 rounded-full text-indigo-400 hover:bg-indigo-200 hover:text-indigo-500 focus:outline-none">
                                <span class="sr-only">Remove ${tag}</span>
                                <svg class="h-2 w-2" stroke="currentColor" fill="none" viewBox="0 0 8 8">
                                    <path stroke-linecap="round" stroke-width="1.5" d="M1 1l6 6m0-6L1 7" />
                                </svg>
                            </button>
                        `;
                        // Bind click
                        span.querySelector('button').addEventListener('click', () => {
                            tags.splice(index, 1);
                            renderTags();
                        });

                        fragment.appendChild(span);
                    });

                    // Insert before input
                    container.insertBefore(fragment, input);

                    hiddenInput.value = tags.join(',');
                }

                function addTag(tag) {
                    tag = tag.trim();
                    if (tag && !tags.includes(tag)) {
                        tags.push(tag);
                        renderTags();
                        input.value = '';
                        dropdown.classList.add('hidden');
                        selectedIndex = -1;
                    }
                }

                input.addEventListener('input', () => {
                    const val = input.value.toLowerCase();
                    dropdown.innerHTML = '';
                    selectedIndex = -1;

                    if (!val) {
                        dropdown.classList.add('hidden');
                        return;
                    }

                    const filtered = AVAILABLE_TAGS.filter(t => t.toLowerCase().includes(val) && !tags.includes(t));

                    if (filtered.length === 0) {
                        dropdown.classList.add('hidden');
                        return;
                    }

                    filtered.forEach((t, index) => {
                        const div = document.createElement('div');
                        div.className = 'cursor-pointer select-none py-2 pl-3 pr-9 hover:bg-indigo-600 hover:text-white text-gray-900';
                        div.textContent = t;
                        div.dataset.index = index;
                        div.addEventListener('click', () => {
                            addTag(t);
                            input.focus();
                        });
                        dropdown.appendChild(div);
                    });
                    dropdown.classList.remove('hidden');
                });

                document.addEventListener('click', (e) => {
                    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.add('hidden');
                        selectedIndex = -1;
                    }
                });

                input.addEventListener('keydown', (e) => {
                    const items = dropdown.querySelectorAll('div');

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (!dropdown.classList.contains('hidden') && items.length > 0) {
                            selectedIndex = (selectedIndex + 1) % items.length;
                            updateSelection(items);
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (!dropdown.classList.contains('hidden') && items.length > 0) {
                            selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                            updateSelection(items);
                        }
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (!dropdown.classList.contains('hidden') && selectedIndex >= 0 && items[selectedIndex]) {
                            items[selectedIndex].click();
                        } else {
                            const val = input.value.trim();
                            if (val) {
                                addTag(val);
                            }
                        }
                    } else if (e.key === 'Backspace' && input.value === '' && tags.length > 0) {
                        tags.pop();
                        renderTags();
                        dropdown.classList.add('hidden');
                    } else if (e.key === 'Escape') {
                        dropdown.classList.add('hidden');
                        selectedIndex = -1;
                    }
                });

                function updateSelection(items) {
                    items.forEach((item, index) => {
                        if (index === selectedIndex) {
                            item.classList.add('bg-indigo-600', 'text-white');
                            item.classList.remove('text-gray-900');
                            item.scrollIntoView({ block: 'nearest' });
                        } else {
                            item.classList.remove('bg-indigo-600', 'text-white');
                            item.classList.add('text-gray-900');
                        }
                    });
                }

                renderTags();


                // --- Ingredient Logic ---
                const ingredientsContainer = document.getElementById('ingredients-container');
                const addIngredientBtn = document.getElementById('add-ingredient-btn');
                const ingredientsHiddenInput = document.getElementById('ingredients_text');

                function createIngredientRow(quantity = '', unit = '', name = '') {
                    const row = document.createElement('div');
                    row.className = 'flex gap-2 items-start';
                    row.innerHTML = `
                        <input type="text" placeholder="Qty" value="${quantity}" class="ing-qty w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                        <input type="text" list="unit-options" placeholder="Unit" value="${unit}" class="ing-unit w-24 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                        <input type="text" placeholder="Ingredient Name" value="${name}" class="ing-name flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
                        <button type="button" class="text-gray-400 hover:text-red-500 p-2 focus:outline-none">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    `;

                    row.querySelector('button').addEventListener('click', () => {
                        row.remove();
                    });

                    return row;
                }

                // Initial parse from hidden input (server rendered)
                // Use structured data if available, otherwise fall back (e.g. legacy/new)
                if (typeof SERVER_INGREDIENTS !== 'undefined' && SERVER_INGREDIENTS.length > 0) {
                    SERVER_INGREDIENTS.forEach(ing => {
                        const q = ing.quantity || '';
                        let u = ing.unit || '';
                        if (typeof u === 'string' && u.toLowerCase() === 'null') u = '';
                        const n = ing.name || '';
                        ingredientsContainer.appendChild(createIngredientRow(q, u, n));
                    });
                } else {
                    const initialText = ingredientsHiddenInput.value;
                    if (initialText.trim()) {
                        initialText.split('\n').forEach(line => {
                            line = line.trim();
                            if (!line) return;

                            // Regex: Start with optional number/fraction, optional unit, then rest is name
                            const match = line.match(/^([\d\/\.\-\s]+)?\s*(?:(cup|cups|tbsp|tsp|oz|lb|g|kg|ml|l|pinch|dash|clove|slice|can|tablespoon|teaspoon)[s]?\.?\s+)?(.*)$/i);

                            if (match) {
                                const q = match[1] ? match[1].trim() : '';
                                const u = match[2] ? match[2].trim() : '';
                                const n = match[3] ? match[3].trim() : '';
                                ingredientsContainer.appendChild(createIngredientRow(q, u, n));
                            } else {
                                // Fallback
                                const parts = line.split(/\s+/);
                                let qty = '';
                                let unit = '';
                                let name = '';
                                let idx = 0;

                                if (parts[idx] && /^[\d\/\.\-]+$/.test(parts[idx])) {
                                    qty = parts[idx];
                                    idx++;
                                }
                                const commonUnits = ['cup', 'cups', 'tbsp', 'tsp', 'oz', 'lb', 'g', 'kg', 'ml', 'l', 'pinch', 'clove', 'can', 'slice'];
                                if (parts[idx] && commonUnits.some(cu => parts[idx].toLowerCase().startsWith(cu))) {
                                    unit = parts[idx];
                                    idx++;
                                }
                                name = parts.slice(idx).join(' ');
                                ingredientsContainer.appendChild(createIngredientRow(qty, unit, name));
                            }
                        });
                    } else {
                        for (let i = 0; i < 6; i++) {
                            ingredientsContainer.appendChild(createIngredientRow());
                        }
                    }
                }

                addIngredientBtn.addEventListener('click', () => {
                    ingredientsContainer.appendChild(createIngredientRow());
                });

                // --- Auto-fill & Submission ---
                const autoFillBtn = document.getElementById('auto-fill-btn');
                const urlInput = document.getElementById('url');
                const titleInput = document.getElementById('title');
                const overviewInput = document.getElementById('overview');
                const instructionsInput = document.getElementById('instructions');
                const importStatus = document.getElementById('import-status');
                const form = document.getElementById('recipe-form');

                autoFillBtn.addEventListener('click', async () => {
                    const url = urlInput.value.trim();
                    if (!url) {
                        alert('Please enter a URL first.');
                        return;
                    }



                    autoFillBtn.disabled = true;
                    importStatus.textContent = 'Fetching and parsing recipe...';
                    importStatus.classList.remove('hidden', 'text-red-600', 'text-green-600');
                    importStatus.classList.add('text-gray-500');

                    try {
                        const response = await fetch('/recipes/import', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url }),
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`Import failed: ${response.status} ${response.statusText} - ${errorText}`);
                        }

                        const data = await response.json();
                        if (data.title) titleInput.value = data.title;
                        if (data.overview) overviewInput.value = data.overview;

                        if (data.ingredients && data.ingredients.length > 0) {
                            ingredientsContainer.innerHTML = '';
                            data.ingredients.forEach(ing => {
                                const q = ing.quantity || '';
                                let u = ing.unit || '';
                                if (typeof u === 'string' && u.toLowerCase() === 'null') u = '';
                                const n = ing.name || '';
                                ingredientsContainer.appendChild(createIngredientRow(q, u, n));
                            });
                        }

                        if (data.instructions && data.instructions.length > 0) {
                            instructionsInput.value = data.instructions.join('\n\n');
                        }

                        importStatus.textContent = 'Import successful!';
                        importStatus.classList.remove('text-gray-500');
                        importStatus.classList.add('text-green-600');

                    } catch (error) {
                        console.error('Import error:', error);
                        importStatus.textContent = `Error: ${error.message}`;
                        importStatus.classList.remove('text-gray-500');
                        importStatus.classList.add('text-red-600');
                    } finally {
                        autoFillBtn.disabled = false;
                    }
                });

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const title = titleInput.value.trim();
                    const url = urlInput.value.trim();
                    const overview = overviewInput.value.trim();
                    const instructions = instructionsInput.value.trim();

                    // Gather ingredients
                    const ingredientRows = ingredientsContainer.querySelectorAll('div.flex');
                    const ingredientsData = [];
                    ingredientRows.forEach(row => {
                        const q = row.querySelector('.ing-qty').value.trim();
                        const u = row.querySelector('.ing-unit').value.trim();
                        const n = row.querySelector('.ing-name').value.trim();

                        if (n) { // Only add if name is present
                            ingredientsData.push({
                                quantity: q || null,
                                unit: u || null,
                                name: n
                            });
                        }
                    });

                    const payload = {
                        title: title,
                        instructions: instructions,
                        ingredients: ingredientsData,
                        tags: tags,
                        url: url,
                        overview: overview
                    };

                    try {
                        const response = await fetch(form.action, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            window.location.href = response.url;
                        } else {
                            const text = await response.text();
                            alert('Failed to save recipe: ' + text);
                        }
                    } catch (error) {
                        console.error('Save error:', error);
                        alert('Failed to save recipe: ' + error.message);
                    }
                });
            });
        </script>

        <div class="flex justify-end space-x-3">
            <a href="{% if is_edit %}/recipes/{{ recipe.as_ref().unwrap().id }}{% else %}/{% endif %}"
                class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</a>
            <button type="submit"
                class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Save</button>
        </div>
    </form>
</div>
{% endblock %}
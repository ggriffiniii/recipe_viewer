{% extends "layout.html" %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <div class="flex items-center space-x-3">
                <h1 class="text-xl sm:text-2xl font-bold text-gray-900">{{ recipe.title }}</h1>
                <a href="/recipes/{{ recipe.id }}/print" target="_blank"
                    class="text-gray-400 hover:text-indigo-600 transition-colors" title="Print View">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0 1 10.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0 .229 2.523a1.125 1.125 0 0 1-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0 0 21 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 0 0-1.913-.247M6.34 18H5.25A2.25 2.25 0 0 1 3 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 0 1 1.913-.247m10.5 0a48.536 48.536 0 0 0-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5Zm-3 0h.008v.008H15V10.5Z" />
                    </svg>
                </a>
            </div>
            {% if let Some(url) = recipe.url %}
            <a href="{{ url }}" target="_blank"
                class="text-xs text-indigo-600 hover:text-indigo-800 hover:underline">Source</a>
            {% endif %}

            {% if !revisions.is_empty() %}
            <div class="mt-1 flex items-center space-x-2 text-xs text-gray-500">
                <span>History:</span>
                <div class="flex flex-wrap gap-1">
                    {% for (rev_num, rev_date) in revisions %}
                    <a href="/recipes/{{ recipe.id }}/versions/{{ rev_num }}" title="{{ rev_date }}"
                        class="px-1.5 py-0.5 rounded border {% if *rev_num == recipe.revision_number %}bg-indigo-600 text-white border-indigo-600{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %}">
                        {{ rev_num }}
                    </a>
                    {% endfor %}
                </div>
            </div>

            {% if let Some((latest_rev, _)) = revisions.first() %}
            {% if *latest_rev > recipe.revision_number %}
            <form action="/recipes/{{ recipe.id }}/restore/{{ recipe.revision_number }}" method="POST" class="mt-2">
                <button type="submit"
                    class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded border border-yellow-200 hover:bg-yellow-200"
                    onclick="return confirm('Restore this version as the new latest revision?')">
                    Restore as Latest
                </button>
            </form>
            {% endif %}
            {% endif %}
            {% endif %}
        </div>
        <div class="flex items-center space-x-2">
            {% if user.is_some() %}
            <a href="/recipes/{{ recipe.id }}/convert"
                class="text-gray-400 hover:text-indigo-600 p-2 rounded-full hover:bg-gray-100 transition-colors flex items-center gap-1"
                title="Convert to Weight">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 54 36" stroke-width="1.5"
                    stroke="currentColor" class="w-14 h-10">
                    <!-- Measuring Cup (Left) shifted down -->
                    <g transform="translate(0, 10)">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M6 3h12l-1.5 16.5a2.25 2.25 0 0 1-2.25 2.25h-4.5a2.25 2.25 0 0 1-2.25-2.25L6 3Z" />
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M18 6.75h1.5a2.25 2.25 0 0 1 2.25 2.25v2.25a2.25 2.25 0 0 1-2.25 2.25h-2.75" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 7.5h6" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 16.5h6" />
                    </g>

                    <!-- Arrow (Block style arc, pointing down-right) -->
                    <!-- Sits in the top space now increased -->
                    <path fill="currentColor"
                        d="M 21 8 L 21 6 Q 27 2 32 6 L 33 4 L 37 9 L 31 10 L 30 8 Q 26 5 21 8 Z" />

                    <!-- Scale (Right) shifted down -->
                    <g transform="translate(26, 10)">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M12 3v17.25m0 0c-1.472 0-2.882.265-4.185.75M12 20.25c1.472 0 2.882.265 4.185.75M18.75 4.97A48.416 48.416 0 0 0 12 4.5c-2.291 0-4.545.16-6.75.47m13.5 0c1.01.143 2.01.317 3 .52m-3-.52 2.62 10.726c.122.499-.106 1.028-.589 1.202a5.988 5.988 0 0 1-2.031.352 5.988 5.988 0 0 1-2.031-.352c-.483-.174-.711-.703-.59-1.202L18.75 4.971Zm-16.5.52c.99-.203 1.99-.377 3-.52m0 0 2.62 10.726c.122.499-.106 1.028-.589 1.202a5.988 5.988 0 0 1-2.031.352 5.988 5.988 0 0 1-2.031-.352c-.483-.174-.711-.703-.59-1.202L5.25 4.971Z" />
                    </g>
                </svg>
            </a>
            <a href="/recipes/{{ recipe.id }}/edit"
                class="text-gray-400 hover:text-indigo-600 p-2 rounded-full hover:bg-gray-100 transition-colors"
                title="Edit Recipe">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                </svg>
            </a>
            <button hx-delete="/recipes/{{ recipe.id }}" hx-confirm="Are you sure you want to delete this recipe?"
                hx-target="body"
                class="text-gray-400 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition-colors"
                title="Delete Recipe">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                </svg>
            </button>
            {% endif %}

            <button id="wake-lock-btn"
                class="text-gray-400 hover:text-yellow-600 p-2 rounded-full hover:bg-yellow-50 transition-colors hidden"
                title="Turn Keep Screen On">
                <!-- Sun Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
                </svg>
            </button>
        </div>
    </div>

    {% if let Some(overview) = recipe.overview %}
    <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-4">
        <div class="px-3 py-3 sm:px-6">
            <h3 class="text-base leading-6 font-medium text-gray-900">Overview</h3>
        </div>
        <div class="border-t border-gray-200 px-3 py-3 sm:p-4">
            <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ overview }}</p>
        </div>
    </div>
    {% endif %}

    <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-4">
        <div class="px-3 py-3 sm:px-6 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-y-2 sm:gap-y-0">
            <h3 class="text-base leading-6 font-medium text-gray-900">Ingredients</h3>
            <div class="flex items-center space-x-2 text-xs">
                <span class="text-gray-500">Scale:</span>
                <div class="space-x-1">
                    <a href="?scale=0.5"
                        class="px-1.5 py-0.5 rounded border {% if scale == 0.5 %}bg-indigo-100 text-indigo-700{% else %}text-gray-600 hover:bg-gray-50{% endif %}">0.5x</a>
                    <a href="?scale=1.0"
                        class="px-1.5 py-0.5 rounded border {% if scale == 1.0 %}bg-indigo-100 text-indigo-700{% else %}text-gray-600 hover:bg-gray-50{% endif %}">1x</a>
                    <a href="?scale=2.0"
                        class="px-1.5 py-0.5 rounded border {% if scale == 2.0 %}bg-indigo-100 text-indigo-700{% else %}text-gray-600 hover:bg-gray-50{% endif %}">2x</a>
                </div>
                <form action="" method="get" class="flex items-center">
                    <input type="number" name="scale" value="{{ scale }}" step="0.1" min="0.1"
                        class="w-12 px-1 py-0.5 text-xs border rounded focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="Custom">
                    <button type="submit"
                        class="ml-1 px-1.5 py-0.5 bg-gray-100 hover:bg-gray-200 border rounded text-xs text-gray-600">Go</button>
                </form>
            </div>
        </div>
        <div class="border-t border-gray-200">
            <ul class="divide-y divide-gray-200 grid grid-cols-1 sm:grid-cols-2 gap-x-4">
                {% for ingredient in ingredients %}
                <li class="px-3 py-2 flex items-baseline">
                    <div class="flex-shrink-0 w-20 text-right mr-3">
                        {% if let Some(qty) = ingredient.display_quantity(*scale) %}
                        <span class="font-bold text-gray-900 text-sm">{{ qty }}</span>
                        {% endif %}
                        {% if let Some(unit) = ingredient.unit %}
                        {% if let Some(q) = ingredient.quantity %}
                        <span class="text-gray-600 text-xs italic ml-1">{{ self.pluralize_unit(unit, q * scale)
                            }}</span>
                        {% else %}
                        <span class="text-gray-600 text-xs italic ml-1">{{ unit }}</span>
                        {% endif %}
                        {% endif %}
                    </div>
                    <span class="text-gray-900 text-sm flex-1">{{ ingredient.name }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    {% if let Some(instructions) = recipe.instructions %}
    <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">
        <div class="px-4 py-5 sm:px-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Instructions</h3>
        </div>
        <div class="border-t border-gray-200 px-4 py-5 sm:p-6">
            <p class="whitespace-pre-wrap text-gray-700">{{ instructions }}</p>
        </div>
    </div>
    {% endif %}

    <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">
        <div class="px-4 py-5 sm:px-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Household Ratings</h3>
        </div>
        <div class="border-t border-gray-200 px-4 py-5 sm:p-6">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                {% for name in ["Glenn", "Carol", "Mackenzie"] %}
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="font-medium text-gray-900 mb-2">{{ name }}</div>
                    <div class="flex items-center space-x-2 rating-container" data-rater="{{ name }}">
                        {% let current_score = 0.0 %}
                        {% for r in ratings %}
                        {% if r.rater_name.eq_ignore_ascii_case(name) %}
                        {% let current_score = r.score %}
                        {% endif %}
                        {% endfor %}

                        <!-- Gradients for stars -->
                        <svg width="0" height="0" class="absolute pointer-events-none">
                            <defs>
                                <linearGradient id="half-gradient-{{ name }}-{{ recipe.id }}" x1="0%" y1="0%" x2="100%"
                                    y2="0%">
                                    <stop offset="50%" class="stop-color-yellow" stop-color="#FBBF24" />
                                    <stop offset="50%" class="stop-color-gray" stop-color="#D1D5DB" />
                                </linearGradient>
                            </defs>
                        </svg>

                        <div class="stars-wrapper flex cursor-pointer">
                            {% for i in [1, 2, 3, 4, 5] %}
                            <!-- Star SVG -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                class="w-10 h-10 rating-star text-gray-300 transition-colors" data-value="{{ i }}">
                                <path fill-rule="evenodd"
                                    d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z"
                                    clip-rule="evenodd" />
                            </svg>
                            {% endfor %}
                        </div>
                        <input type="number"
                            class="bg-transparent border-none focus:ring-0 p-0 text-xs text-gray-400 w-8 text-right rating-input"
                            step="0.5" min="0" max="5" readonly tabindex="-1">
                    </div>
                </div>
                {% endfor %}
            </div>
            <script>
                (function () {
                    try {
                        const ratingsList = [
                            {% for r in ratings %}
                            { name: "{{ r.rater_name }}", score: parseFloat({{ r.score }})
                },
                    {% endfor %}
                        ];

                const ratingsMap = {};
                ratingsList.forEach(item => {
                    if (item.name) {
                        ratingsMap[item.name.toLowerCase()] = item.score;
                    }
                });

                const containers = document.querySelectorAll('.rating-container');

                containers.forEach(container => {
                    try {
                        const rater = container.dataset.rater;
                        // Unique ID for gradient reference
                        const gradientId = `half-gradient-${rater}-{{ recipe.id }}`;

                        const score = ratingsMap[rater.toLowerCase()] || 0;

                        const input = container.querySelector('.rating-input');
                        const stars = container.querySelectorAll('.rating-star');

                        // Init
                        input.value = score > 0 ? score.toFixed(1) : '';
                        updateStars(stars, score, gradientId);

                        // Star click/touch logic
                        stars.forEach((star, index) => {
                            star.addEventListener('click', (e) => {
                                const starIndex = index + 1;
                                const currentVal = parseFloat(input.value) || 0;
                                let newScore = starIndex;

                                // 3-Step Toggle Logic: Full -> Half -> Clear
                                if (currentVal === starIndex) {
                                    // Ensure float comparison is safe (it is for .5 and .0)
                                    newScore = starIndex - 0.5;
                                } else if (currentVal === starIndex - 0.5) {
                                    newScore = 0;
                                }

                                input.value = newScore > 0 ? newScore.toFixed(1) : '';
                                saveRating(rater, newScore);
                                updateStars(stars, newScore, gradientId);
                            });
                        });

                    } catch (e) {
                        console.error("Error processing container", container, e);
                    }
                });


                function updateStars(stars, score, gradientId) {
                    stars.forEach((star, index) => {
                        const starVal = index + 1; // 1, 2, 3, 4, 5

                        // Reset classes/styles
                        star.classList.remove('text-yellow-400', 'text-gray-300');
                        star.style.fill = ''; // Reset inline fill style

                        if (score >= starVal) {
                            // Full star
                            star.classList.add('text-yellow-400');
                        } else if (score >= starVal - 0.5) {
                            // Half star
                            // We need to apply the gradient or a partial fill
                            // SVG linear gradient approach
                            star.classList.add('text-yellow-400'); // text color might ignore if fill is set?
                            // Actually text-yellow-400 usually sets fill via currentColor.
                            // To use gradient, we must set fill explicitly.
                            star.style.fill = `url(#${gradientId})`;
                        } else {
                            // Empty star
                            star.classList.add('text-gray-300');
                        }
                    });
                } function saveRating(rater, score) {
                    const params = new URLSearchParams();
                    params.append('rater_name', rater);
                    params.append('score', score);

                    fetch(`/recipes/{{ recipe.id }}/ratings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: params
                    }).then(res => {
                        if (!res.ok) console.error("Failed to save rating");
                    })
                        .catch(err => console.error('Error saving rating:', err));
                }

                    } catch (e) {
                    console.error("Global ratings script error", e);
                }
                }) ();
            </script>
        </div>
    </div>

    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Tags</h3>
            {% if user.is_some() %}
            <span class="text-xs text-gray-500">Edit tags below</span>
            {% endif %}
        </div>
        <div class="border-t border-gray-200 px-4 py-5 sm:p-6">
            {% if user.is_some() %}
            <div class="relative mb-3">
                <div id="tags-container"
                    class="mt-1 flex flex-wrap gap-2 p-2 border border-gray-300 rounded-md bg-white min-h-[42px] focus-within:ring-1 focus-within:ring-indigo-500 focus-within:border-indigo-500 shadow-sm">
                    <input type="text" id="tag-input"
                        class="flex-grow min-w-[120px] outline-none border-none focus:ring-0 p-0 text-sm"
                        placeholder="Add a tag..." autocomplete="off">
                </div>
                <div id="tag-dropdown"
                    class="absolute z-10 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm hidden">
                </div>
            </div>

            <input type="hidden" name="tags_text" id="tags_text"
                value="{% for tag in tags %}{{ tag.name }}{% if !loop.last %}, {% endif %}{% endfor %}">

            <script>
                const AVAILABLE_TAGS = [
                    {% for tag in all_tags %}"{{ tag }}"{% if !loop.last %}, {% endif %} {% endfor %}
                ];

                document.addEventListener('DOMContentLoaded', () => {
                    const container = document.getElementById('tags-container');
                    const input = document.getElementById('tag-input');
                    const hiddenInput = document.getElementById('tags_text');
                    const dropdown = document.getElementById('tag-dropdown');

                    let tags = hiddenInput.value.split(',')
                        .map(t => t.trim())
                        .filter(t => t.length > 0);

                    let selectedIndex = -1;

                    function saveTags() {
                        const tagsText = tags.join(', ');
                        hiddenInput.value = tagsText;

                        // Send updates to server
                        const params = new URLSearchParams();
                        params.append('tags_text', tagsText);

                        fetch('/recipes/{{ recipe.id }}/tags', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: params
                        }).then(response => {
                            if (!response.ok) {
                                console.error('Failed to save tags');
                                // Optional: show error feedback
                            }
                        }).catch(error => {
                            console.error('Error saving tags:', error);
                        });
                    }

                    function createBadge(text) {
                        const span = document.createElement('span');
                        span.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800';
                        span.innerHTML = `
                            ${text}
                            <button type="button" class="ml-1.5 inline-flex h-4 w-4 flex-shrink-0 items-center justify-center rounded-full text-indigo-400 hover:bg-indigo-200 hover:text-indigo-500 focus:bg-indigo-500 focus:text-white focus:outline-none">
                                <svg class="h-2 w-2" stroke="currentColor" fill="none" viewBox="0 0 8 8">
                                    <path stroke-linecap="round" stroke-width="1.5" d="M1 1l6 6m0-6L1 7" />
                                </svg>
                            </button>
                        `;

                        span.querySelector('button').addEventListener('click', () => {
                            tags = tags.filter(t => t !== text);
                            saveTags();
                            span.remove();
                        });

                        return span;
                    }

                    function renderTags() {
                        const badges = container.querySelectorAll('span');
                        badges.forEach(b => b.remove());
                        tags.forEach(tag => {
                            container.insertBefore(createBadge(tag), input);
                        });
                    }

                    function renderDropdown(filterText) {
                        dropdown.innerHTML = '';
                        let matches = [];

                        if (!filterText) {
                            matches = AVAILABLE_TAGS.filter(t => !tags.includes(t)).slice(0, 10);
                        } else {
                            const lowerFilter = filterText.toLowerCase();
                            matches = AVAILABLE_TAGS
                                .filter(t => t.toLowerCase().includes(lowerFilter) && !tags.includes(t))
                                .slice(0, 10);
                        }

                        if (matches.length > 0) {
                            matches.forEach((tag, index) => {
                                const div = document.createElement('div');
                                div.className = 'cursor-default select-none relative py-2 pl-3 pr-9 hover:bg-indigo-600 hover:text-white text-gray-900';
                                div.textContent = tag;
                                div.addEventListener('mousedown', (e) => {
                                    e.preventDefault();
                                    addTag(tag);
                                });
                                dropdown.appendChild(div);
                            });
                            dropdown.classList.remove('hidden');
                            selectedIndex = -1;
                        } else {
                            dropdown.classList.add('hidden');
                        }
                    }

                    function addTag(tag) {
                        if (tag && !tags.includes(tag)) {
                            tags.push(tag);
                            saveTags();
                            container.insertBefore(createBadge(tag), input);
                            input.value = '';
                            dropdown.classList.add('hidden');
                        }
                        input.focus();
                    }

                    renderTags();

                    input.addEventListener('input', () => renderDropdown(input.value.trim()));
                    input.addEventListener('focus', () => renderDropdown(input.value.trim()));
                    input.addEventListener('blur', () => setTimeout(() => dropdown.classList.add('hidden'), 200));

                    function highlightOption(index) {
                        const options = dropdown.children;
                        for (let i = 0; i < options.length; i++) {
                            if (i === index) {
                                options[i].classList.add('bg-indigo-600', 'text-white');
                                options[i].classList.remove('text-gray-900');
                            } else {
                                options[i].classList.remove('bg-indigo-600', 'text-white');
                                options[i].classList.add('text-gray-900');
                            }
                        }
                    }

                    input.addEventListener('keydown', (e) => {
                        const options = dropdown.children;

                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            if (dropdown.classList.contains('hidden')) {
                                renderDropdown(input.value.trim());
                            } else if (options.length > 0) {
                                selectedIndex = (selectedIndex + 1) % options.length;
                                highlightOption(selectedIndex);
                            }
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            if (dropdown.classList.contains('hidden')) {
                                renderDropdown(input.value.trim());
                            } else if (options.length > 0) {
                                selectedIndex = (selectedIndex - 1 + options.length) % options.length;
                                highlightOption(selectedIndex);
                            }
                        } else if (e.key === 'Enter') {
                            e.preventDefault();
                            if (!dropdown.classList.contains('hidden') && selectedIndex >= 0 && selectedIndex < options.length) {
                                addTag(options[selectedIndex].textContent);
                            } else {
                                const val = input.value.trim();
                                if (val) addTag(val);
                            }
                        } else if (e.key === ',') {
                            e.preventDefault();
                            const val = input.value.trim();
                            if (val) addTag(val);
                        } else if (e.key === 'Backspace' && input.value === '' && tags.length > 0) {
                            tags.pop();
                            saveTags();
                            renderTags();
                            dropdown.classList.add('hidden');
                        }
                    });

                    container.addEventListener('click', () => input.focus());
                });
            </script>
            {% else %}
            <div class="flex flex-wrap gap-2">
                {% for tag in tags %}
                <span
                    class="inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                    {{ tag.name }}
                </span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Wake Lock Logic
            if ('wakeLock' in navigator) {
                const wakeLockBtn = document.getElementById('wake-lock-btn');
                let wakeLock = null;

                wakeLockBtn.classList.remove('hidden');

                const updateUI = (active) => {
                    if (active) {
                        wakeLockBtn.classList.add('text-yellow-600', 'bg-yellow-50');
                        wakeLockBtn.classList.remove('text-gray-400');
                        wakeLockBtn.querySelector('svg').setAttribute('fill', 'currentColor');
                        wakeLockBtn.setAttribute('title', 'Screen is ON (Click to disable)');
                    } else {
                        wakeLockBtn.classList.remove('text-yellow-600', 'bg-yellow-50');
                        wakeLockBtn.classList.add('text-gray-400');
                        wakeLockBtn.querySelector('svg').removeAttribute('fill');
                        wakeLockBtn.setAttribute('title', 'Keep screen ON (Click to enable)');
                    }
                };

                const requestWakeLock = async () => {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        wakeLock.addEventListener('release', () => {
                            console.log('Wake Lock was released');
                            wakeLock = null;
                            updateUI(false);
                        });
                        console.log('Wake Lock is active');
                        updateUI(true);
                    } catch (err) {
                        console.error(`${err.name}, ${err.message}`);
                    }
                };

                const releaseWakeLock = async () => {
                    if (wakeLock !== null) {
                        await wakeLock.release();
                        wakeLock = null;
                    }
                };

                wakeLockBtn.addEventListener('click', () => {
                    if (wakeLock === null) {
                        requestWakeLock();
                    } else {
                        releaseWakeLock();
                    }
                });

                // Re-acquire lock when page becomes visible again
                document.addEventListener('visibilitychange', async () => {
                    if (wakeLock !== null && document.visibilityState === 'visible') {
                        requestWakeLock();
                    }
                });
            }
        });
    </script>
    {% endblock %}
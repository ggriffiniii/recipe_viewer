<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Viewer</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-900 font-sans">
    <nav class="bg-white shadow p-3 mb-6">
        <div class="container mx-auto flex flex-row justify-between items-center gap-2 md:gap-4">
            <a href="/"
                class="text-xl font-bold text-indigo-600 hover:text-indigo-800 transition whitespace-nowrap hidden md:block">Recipes</a>

            <!-- Global Search Bar -->
            <div class="flex-grow w-full md:w-auto md:mx-8">
                {% block header_search %}
                <div id="header-search-wrapper" class="w-full">
                    <form action="/" method="get" class="relative w-full">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>
                        <input type="text" name="q" id="search-q" placeholder="Search recipes..."
                            class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm">

                        <!-- Search Indicator -->
                        <div
                            class="htmx-indicator absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <svg class="animate-spin h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                        </div>
                    </form>
                </div>
                {% endblock %}
            </div>

            <div class="flex items-center space-x-3 whitespace-nowrap">
                {% if let Some(email) = user %}
                <a href="/recipes/new"
                    class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm shadow transition hover:-translate-y-0.5 flex items-center gap-1">
                    <span>+</span> <span class="hidden sm:inline">New</span>
                </a>
                <div class="relative ml-3">
                    <button id="user-menu-btn"
                        class="flex items-center justify-center w-8 h-8 rounded-full bg-indigo-600 text-white text-sm font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        {{ email.chars().next().unwrap_or('?').to_uppercase() }}
                    </button>
                    <!-- Dropdown menu -->
                    <div id="user-menu-dropdown"
                        class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden focus:outline-none z-50">
                        <div class="px-4 py-3 border-b border-gray-100">
                            <p class="text-sm text-gray-900 truncate font-medium" title="{{ email }}">
                                {{ email }}
                            </p>
                        </div>
                        <a href="/logout" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign out</a>
                    </div>
                </div>

                <script>
                    document.addEventListener('DOMContentLoaded', () => {
                        const menuBtn = document.getElementById('user-menu-btn');
                        const dropdown = document.getElementById('user-menu-dropdown');

                        if (menuBtn && dropdown) {
                            menuBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                dropdown.classList.toggle('hidden');
                            });

                            document.addEventListener('click', (e) => {
                                if (!dropdown.classList.contains('hidden')) {
                                    dropdown.classList.add('hidden');
                                }
                            });

                            dropdown.addEventListener('click', (e) => {
                                e.stopPropagation();
                            });
                        }

                        // HTMX Focus Retention for Search
                        let searchFocus = null;
                        document.addEventListener('htmx:beforeRequest', (e) => {
                            const input = document.getElementById('search-q');
                            if (input && document.activeElement === input) {
                                searchFocus = {
                                    start: input.selectionStart,
                                    end: input.selectionEnd
                                };
                            }
                        });

                        document.addEventListener('htmx:afterSettle', (e) => {
                            if (searchFocus) {
                                const input = document.getElementById('search-q');
                                if (input) {
                                    input.focus();
                                    input.setSelectionRange(searchFocus.start, searchFocus.end);
                                }
                                searchFocus = null;
                            }
                        });
                    });
                </script>
                {% else %}
                <a href="/auth/google"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm flex items-center gap-2 transition hover:scale-105 shadow">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.539-6.033-6.033s2.701-6.033,6.033-6.033c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z" />
                    </svg>
                    <span class="hidden sm:inline">Login</span>
                </a>
                {% endif %}
            </div>
        </div>
    </nav>
    <main class="container mx-auto p-4">
        {% block content %}{% endblock %}
    </main>
</body>

</html>